---
title: "Panorama Estado do RJ Covid-19"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: fill
---
  
```{r setup, include=FALSE}
{library(flexdashboard)
  library(tidyverse)
  library(ggimage)
  library(gganimate)
  library(png)
  library(RCurl)
  library(lubridate)
  library(tmap)
  #devtools::install_github("rpradosiqueira/brazilmaps")
  library(brazilmaps)
  library(readxl)
  library(gridExtra)
  library(ggrepel)
  library(scales)
  library(stringr)
  library(ggthemes)
  library(transformr)
  library(gifski)
  library(RColorBrewer)
  library(grid)
  library(viridis)
  library(hrbrthemes)
  library(pracma)
  library(stringi)
  library(ggsn)
  library(magick)
  library(cowplot)
  library(plotly)
}

##Para baixar dados .gz
con <- gzcon(url(paste("https://github.com/wcota/covid19br/blob/master/cases-brazil-cities-time.csv.gz?raw=true","aa_combined-20110321.csv.gz", sep="")))
dat <- read_csv(con)
RJ <- filter(dat, state=="RJ")

#########################################################################################
#Primeira Dose

temp <- tempfile()

download.file(url = "http://sistemas.saude.rj.gov.br/tabnetbd/csv/pni_covid16376887451.xlsx", 
              destfile = temp, mode="wb")

dados <- read_excel(temp)
dados <- dados[-c(1:3,5),]
names(dados)= dados[1,]
dados <- dados[-c(1),]
dados <- select(dados, -Total)

dados = dados |> 
  rename(date='Data de aplicação') 

dados$date= as.Date.character(dados$date, tryFormats= "%Y/%m/%d")

dados$date= as.character(dados$date)
for (i in 1:length(dados$date)){
  if(is.na(dados$date[i]==T)) dados$date[i]="Nao informado"
}
dados= dplyr::filter(dados, date!="Nao informado")
#dados$date= as.Date.character(dados$date, tryFormats= "%Y/%m/%d")

dados_reorg = dados |> 
  gather(key = "city",
         value = "D1",
         2:93)

dados_reorg$D1= as.numeric(dados_reorg$D1) 

###############################################################################################

#Segunda Dose/ Dose Unica

temp <- tempfile()

download.file(url = "http://sistemas.saude.rj.gov.br/tabnetbd/csv/pni_covid16376887498.xlsx", 
              destfile = temp, mode="wb")

dados2 <- read_excel(temp)
dados2 <- dados2[-c(1:3,5),]
names(dados2)= dados2[1,]
dados2 <- dados2[-c(1),]
dados2 <- select(dados2, -Total)

dados2 = dados2 |> 
  rename(date='Data de aplicação') 

dados2$date= as.Date.character(dados2$date, tryFormats= "%Y/%m/%d")

dados2$date= as.character(dados2$date)
for (i in 1:length(dados2$date)){
  if(is.na(dados2$date[i]==T)) dados2$date[i]="Nao informado"
}
dados2= dplyr::filter(dados2, date!="Nao informado")
#dados2$date= as.Date.character(dados2$date, tryFormats= "%Y/%m/%d")

dados2_reorg = dados2 |> 
  gather(key = "city",
         value = "D2",
         2:93)

dados2_reorg$D2= as.numeric(dados2_reorg$D2) 

###############################################################################################

#Terceira Dose

temp <- tempfile()

download.file(url = "http://sistemas.saude.rj.gov.br/tabnetbd/csv/pni_covid16376887514.xlsx", 
              destfile = temp, mode="wb")

dados3 <- read_excel(temp)
dados3 <- dados3[-c(1:3,5),]
names(dados3)= dados3[1,]
dados3 <- dados3[-c(1),]
dados3 <- select(dados3, -Total)

dados3 = dados3 |> 
  rename(date='Data de aplicação') 

dados3$date= as.Date.character(dados3$date, tryFormats= "%Y/%m/%d")

dados3$date= as.character(dados3$date)
for (i in 1:length(dados3$date)){
  if(is.na(dados3$date[i]==T)) dados3$date[i]="Nao informado"
}
dados3= dplyr::filter(dados3, date!="Nao informado")
#dados3$date= as.Date.character(dados3$date, tryFormats= "%Y/%m/%d")

dados3_reorg = dados3 |> 
  gather(key = "city",
         value = "D3",
         2:87)

dados3_reorg$D3= as.numeric(dados3_reorg$D3) 

###############################################################################################

dados = dados_reorg |> 
  left_join(dados2_reorg, by=c("city", "date"))

dados = dados |> 
  left_join(dados3_reorg, by=c("city", "date")) 

  
RJ$date= as.character(RJ$date)

RJ = RJ |> 
  mutate(city = sub(pattern = "/RJ", replacement = "", x = city)) |> 
  filter(city!="CASO SEM LOCALIZAÇÃO DEFINIDA") |> 
  left_join(dados, by=c("city", "date"))

RJ$date= as.Date.character(RJ$date, tryFormats= "%Y-%m-%d")

###############################################################################################
#Metodo2, ele baixa no tempfile
temp <- tempfile()

data_sis <- Sys.Date()-2

download.file(url = paste0("https://s3-sa-east-1.amazonaws.com/ckan.saude.gov.br/Leitos/",data_sis,"/esus-vepi.LeitoOcupacao.csv"),
              destfile = temp)

leitos <- read_csv(temp)
leitos <- leitos |> 
  filter(estado=="Rio de Janeiro") |>
  rename(city= municipio, date= dataNotificacao) |> 
  select(city, date, ocupacaoConfirmadoCli, ocupacaoConfirmadoUti) |> 
  mutate(date= format(date,"%Y-%m-%d")) |> 
  group_by(city, date) |> 
  summarise(ocupacaoConfirmadoCli= sum(ocupacaoConfirmadoCli),
            ocupacaoConfirmadoUti= sum(ocupacaoConfirmadoUti)) 

RJ$date= as.character(RJ$date)

RJ= RJ |> 
  left_join(leitos, by=c("city", "date"))

RJ$date= as.Date.character(RJ$date, tryFormats= "%Y-%m-%d")

load("municipio.rdata")

#casosRJ_final = BaseFinalRJ
casosRJ_final = RJ


#table(casosRJ_final$Municipios)
casosRJ_final <- casosRJ_final |> dplyr::filter(ibgeID!=33)
municipios |> dplyr::rename(ibeID=populacao)
municipios$ibgeID <- as.numeric(municipios$ibgeID)
casosRJ_final <- left_join(casosRJ_final, municipios, by="ibgeID")

aux_semana <- casosRJ_final |> 
  dplyr::distinct(epi_week)

aux_nome <- casosRJ_final |> 
  dplyr::distinct(city)

casosRJ_final$date <- ymd(casosRJ_final$date)
aux_data = casosRJ_final |> 
  distinct(date)

MM_casos = matrix(NA, dim(aux_nome)[1], nrow = length(aux_data$date))
MM_obitos = matrix(NA, ncol = dim(aux_nome)[1], nrow = length(aux_data$date))
MM_vacina = matrix(NA, ncol=dim(aux_nome)[1], nrow = length(aux_data$date))
MM_vacina2 = matrix(NA, ncol=dim(aux_nome)[1], nrow = length(aux_data$date))
MM_ocup_Cli = matrix(NA, ncol=dim(aux_nome)[1], nrow = length(aux_data$date))
MM_ocup_Uti = matrix(NA, ncol=dim(aux_nome)[1], nrow = length(aux_data$date))


j = 1
for(i in aux_nome$city){
  base_aux = casosRJ_final  |>
    filter(city == i) |> 
    arrange(date) |>
    distinct(city, date, .keep_all = T)
  l = as.numeric(difftime(base_aux$date[1], as.Date("2020-03-05", units="days"))+1)
  d = as.numeric(as.numeric(difftime(max(base_aux$date), as.Date("2020-03-05", units="days"))+1))
  
  MM_casos[l:d,j] = movavg(base_aux$newCases, n = 7,type = "s")
  
  MM_obitos[l:d,j] = movavg(base_aux$newDeaths, n = 7,type = "s")
  
  MM_vacina[l:d,j] = movavg(base_aux$D1, n=7, type="s")
  
  MM_vacina2[l:d,j] = movavg(base_aux$D2, n=7, type="s")
  
  MM_ocup_Cli[l:d,j] = movavg(base_aux$ocupacaoConfirmadoCli, n=7, type="s")
  
  MM_ocup_Uti[l:d,j] = movavg(base_aux$ocupacaoConfirmadoUti, n=7, type="s")
  
  j = j+1
}

colnames(MM_casos) = aux_nome$city
colnames(MM_obitos) = aux_nome$city
colnames(MM_vacina) = aux_nome$city
colnames(MM_vacina2) = aux_nome$city
colnames(MM_ocup_Cli) = aux_nome$city
colnames(MM_ocup_Uti) = aux_nome$city

#Criando a base empilhada de casos
MM_aux_casos = as_tibble(MM_casos)
MM_aux_casos$date = aux_data$date
MM_aux_geral_casos = gather(MM_aux_casos, key = "city", value = "MM_casos", -date)

#Criando a base empilhada dos obitos
MM_aux_obitos = as_tibble(MM_obitos)
MM_aux_obitos$date = aux_data$date
MM_aux_geral_obitos = gather(MM_aux_obitos, key = "city", value = "MM_obitos", -date)

#Criando a base empilhada dos vacinados de 1 dose
MM_aux_vacina <- as_tibble(MM_vacina)
MM_aux_vacina$date <- aux_data$date
MM_aux_geral_vacina <- gather(MM_aux_vacina, key = "city", value = "MM_vacina", -date)

#Criando a base empilhada dos vacinados de 2 dose
MM_aux_vacina2 <- as_tibble(MM_vacina2)
MM_aux_vacina2$date <- aux_data$date
MM_aux_geral_vacina2 <- gather(MM_aux_vacina2, key = "city", value = "MM_vacina2", -date)

#Criando a base empilhada dos leitos clinicos ocupados
MM_aux_ocup_Cli <- as_tibble(MM_ocup_Cli)
MM_aux_ocup_Cli$date <- aux_data$date
MM_aux_geral_ocup_Cli <- gather(MM_aux_ocup_Cli, key = "city", value = "MM_ocup_Cli", -date)

#Criando a base empilhada dos leitos de UTI ocupados
MM_aux_ocup_Uti <- as_tibble(MM_ocup_Uti)
MM_aux_ocup_Uti$date <- aux_data$date
MM_aux_geral_ocup_Uti <- gather(MM_aux_ocup_Uti, key = "city", value = "MM_ocup_Uti", -date)

casosRJ_final = left_join(casosRJ_final,MM_aux_geral_casos, by = c("date", "city"))

casosRJ_final = left_join(casosRJ_final,MM_aux_geral_obitos, by = c("date", "city"))

casosRJ_final = left_join(casosRJ_final,MM_aux_geral_vacina, by = c("date", "city"))

casosRJ_final = left_join(casosRJ_final,MM_aux_geral_vacina2, by = c("date", "city"))

casosRJ_final = left_join(casosRJ_final,MM_aux_geral_ocup_Cli, by = c("date", "city"))

casosRJ_final = left_join(casosRJ_final,MM_aux_geral_ocup_Uti, by = c("date", "city"))

#pop dos estados do Brasil 2021 (na coluna Valor)
#estados = get_sidra(api="/t/6579/n3/all/v/all/p/last%201")
#estados = estados |> 
#  rename(ibgeID= 'Unidade da Federação (Código)', populacao= Valor) |> 
#  arrange(ibgeID) |> 
#  select(ibgeID, populacao)
casosRJ_final$populacao= 17463349

#save(casosRJ_final, file="casosRJ_final.rdata")

########################################################################################
#SRAG20
temp <- tempfile()

#data_sis <- format(Sys.Date()-7, "%d-%m-%Y")

download.file(url = "https://s3-sa-east-1.amazonaws.com/ckan.saude.gov.br/SRAG/2020/INFLUD-29-11-2021.csv",
              destfile = temp)

srag20 <- readr::read_csv2(temp)

#idade
for (i in 1:length(srag20$NU_IDADE_N)){
  if(srag20$TP_IDADE[i]!=3) srag20$NU_IDADE_N[i]=0
}

srag20$DT_INTERNA= as.Date.character(srag20$DT_INTERNA, tryFormats= "%d/%m/%Y")
srag20$DT_ENTUTI= as.Date.character(srag20$DT_ENTUTI, tryFormats= "%d/%m/%Y")
srag20$DT_SAIDUTI= as.Date.character(srag20$DT_SAIDUTI, tryFormats= "%d/%m/%Y")
srag20$DT_EVOLUCA= as.Date.character(srag20$DT_EVOLUCA, tryFormats= "%d/%m/%Y")

#save(srag20, file="srag20.rdata")

##################################################################################################

#SRAG21
temp <- tempfile()

#data_sis <- format(Sys.Date()-7, "%d-%m-%Y")

download.file(url = "https://s3-sa-east-1.amazonaws.com/ckan.saude.gov.br/SRAG/2021/INFLUD21-29-11-2021.csv",
              destfile = temp)

srag21 <- readr::read_csv2(temp)

#idade
for (i in 1:length(srag21$NU_IDADE_N)){
  if(srag21$TP_IDADE[i]!=3) srag21$NU_IDADE_N[i]=0
}

srag21$DT_INTERNA= as.Date.character(srag21$DT_INTERNA, tryFormats= "%d/%m/%Y")
srag21$DT_ENTUTI= as.Date.character(srag21$DT_ENTUTI, tryFormats= "%d/%m/%Y")
srag21$DT_SAIDUTI= as.Date.character(srag21$DT_SAIDUTI, tryFormats= "%d/%m/%Y")
srag21$DT_EVOLUCA= as.Date.character(srag21$DT_EVOLUCA, tryFormats= "%d/%m/%Y")

#save(srag21, file="srag21.rdata")

##################################################################################################

img = readPNG("logo_get_uff_covid.png")
image = image_fill(image_read("logo_get_uff_covid.png"),"none")
raster = as.raster(image)
doses = readPNG("doses.png")

RJ_Total = casosRJ_final

RJ_Total = RJ_Total |> 
  group_by(date) |> 
  summarise(contagem= n(), newDeaths= sum(newDeaths, na.rm=T), deaths= sum(deaths, na.rm=T), 
            newCases= sum(newCases, na.rm=T), totalCases= sum(totalCases, na.rm=T), D1= sum(D1,   na.rm=T), D2= sum(D2, na.rm=T), D3= sum(D3, na.rm=T), ocupacaoConfirmadoCli= sum(ocupacaoConfirmadoCli, na.rm=T), ocupacaoConfirmadoUti= sum(ocupacaoConfirmadoUti, na.rm=T))

RJ_Total$MM_casos = round(movavg(RJ_Total$newCases, n = 7,type = "s"),0)
  
RJ_Total$MM_obitos = round(movavg(RJ_Total$newDeaths, n = 7,type = "s"),0)
  
RJ_Total$MM_vacina = round(movavg(RJ_Total$D1, n=7, type="s"),0)
  
RJ_Total$MM_vacina2 = round(movavg(RJ_Total$D2, n=7, type="s"),0)
  
RJ_Total$MM_ocup_Cli = round(movavg(RJ_Total$ocupacaoConfirmadoCli, n=7, type="s"),0)
  
RJ_Total$MM_ocup_Uti = round(movavg(RJ_Total$ocupacaoConfirmadoUti, n=7, type="s"),0)

########################################################################################
srag20 = srag20 |> 
  select(NU_IDADE_N, CLASSI_FIN, DT_INTERNA, SG_UF_INTE, UTI:DT_SAIDUTI, DT_EVOLUCA) |> 
  filter(CLASSI_FIN==5, SG_UF_INTE== "RJ") |> 
  select(-c(CLASSI_FIN, SG_UF_INTE)) |> 
  rename(IDADE= NU_IDADE_N) |> 
  mutate(ANO= year(DT_INTERNA)) |> 
  filter(ANO== 2020 | ANO== 2021) |> 
  arrange(DT_INTERNA)

srag21 = srag21 |> 
  select(NU_IDADE_N, CLASSI_FIN, DT_INTERNA, SG_UF_INTE, UTI:DT_SAIDUTI, DT_EVOLUCA) |> 
  filter(CLASSI_FIN==5, SG_UF_INTE== "RJ") |> 
  select(-c(CLASSI_FIN, SG_UF_INTE)) |> 
  rename(IDADE= NU_IDADE_N) |> 
  mutate(ANO= year(DT_INTERNA)) |> 
  filter(ANO== 2020 | ANO== 2021) |> 
  arrange(DT_INTERNA)

srag = bind_rows(srag20, srag21)

srag$FAIXA= cut(srag$IDADE, breaks= c(-Inf, 1, 6, 20, 30, 40, 50, 60, 70, 80, 90, Inf), right= F)
srag <- srag |> 
  mutate(FAIXA = factor(FAIXA, labels = c("<1","1 a 5","6 a 19","20 a 29","30 a 39","40 a 49",
                                          "50 a 59","60 a 69","70 a 79","80 a 89","90 ou mais")))
########################################################################################
```

Resumos diários Covid-19
=======================================================================
  
column {data-width=500, .tabset}
-----------------------------------------------------------------------
  
### Casos diários
  
```{r}
RJ_Total$`Média móvel` <- round(RJ_Total$MM_casos,0)
RJ_Total$`Casos novos` <- RJ_Total$newCases
RJ_Total$Data <- RJ_Total$date

g1 <- RJ_Total |> ggplot(aes(x=Data, y=`Casos novos`))+ 
  geom_bar(stat="identity",
           fill="orange")+
  geom_line(aes(y=`Média móvel`),
            col="blue")+
  scale_x_date(date_breaks = "2 month",
               date_labels = "%b/%y")+
  scale_y_continuous(label = scales::label_number(big.mark = ".",
                                                  decimal.mark = ",")) +
  labs(title="Casos diários", y= "Casos Novos", x="data")+
  theme_tufte()+
  theme(plot.title = element_text(hjust = 0.5, size=12, face="bold"),
        text = element_text(size=15))

ggplotly(g1) |> 
   layout(images = list(
     list(source = raster2uri(raster),
          xref = "container",
          yref = "container",
          x = 0.1,
          y = 1,
          sizex = 0.15,
          sizey = 0.15,
          opacity = 1.6)
   ))

```

### Óbitos diários

```{r}
RJ_Total$`Média móvel` <- round(RJ_Total$MM_obitos,0)
RJ_Total$`Óbitos novos` <- RJ_Total$newDeaths

g2 <- RJ_Total |> ggplot(aes(x=Data, y=`Óbitos novos`))+ 
  geom_bar(stat="identity",
           fill="orange")+
  geom_line(aes(y=`Média móvel`),
            col="blue")+
  scale_x_date(date_breaks = "2 month",
               date_labels = "%b/%y")+
  scale_y_continuous(label = scales::label_number(big.mark = ".",
                                                  decimal.mark = ",")) +
  labs(title="Óbitos diários", y= "Óbitos Novos", x="data")+
  theme_tufte()+
  theme(plot.title = element_text(hjust = 0.5, size=12, face="bold"),
        text = element_text(size=15))

ggplotly(g2) |> 
   layout(images = list(
     list(source = raster2uri(raster),
          xref = "container",
          yref = "container",
          x = 0.1,
          y = 1,
          sizex = 0.15,
          sizey = 0.15,
          opacity = 1.6)
   ))

```

### Ocupação diária de leitos clínicos
  
```{r}
RJ_Total$`Leitos clínicos ocupados` <- RJ_Total$ocupacaoConfirmadoCli
RJ_Total$`média móvel` <- RJ_Total$MM_ocup_Cli

g7 <- RJ_Total |> ggplot(aes(x=Data, y=`Leitos clínicos ocupados`))+ 
  geom_bar(stat="identity",
           fill="orange")+
  geom_line(aes(y=`média móvel`),
            col="blue")+
  scale_x_date(date_breaks = "2 month",
               date_labels = "%b/%y")+
  scale_y_continuous(label = scales::label_number(big.mark = ".",
                                                  decimal.mark = ",")) +
  labs(title="Ocupação diária de leitos clínicos", y= "Leitos clínicos ocupados", x="data")+
  theme_tufte()+
  theme(plot.title = element_text(hjust = 0.5, size=12, face="bold"),
        text = element_text(size=15))

ggplotly(g7) |> 
   layout(images = list(
     list(source = raster2uri(raster),
          xref = "container",
          yref = "container",
          x = 0.1,
          y = 1,
          sizex = 0.15,
          sizey = 0.15,
          opacity = 1.6)
   ))

```

### Ocupação diária de leitos de UTI
  
```{r}
RJ_Total$`Leitos UTI ocupados` <- RJ_Total$ocupacaoConfirmadoUti
RJ_Total$`média móvel` <- RJ_Total$MM_ocup_Uti

g8 <- RJ_Total |> ggplot(aes(x=Data, y=`Leitos UTI ocupados`))+
  geom_bar(stat="identity",
           fill="orange")+
  geom_line(aes(y=`média móvel`),
            col="blue")+
  scale_x_date(date_breaks = "2 month",
               date_labels = "%b/%y")+
  scale_y_continuous(label = scales::label_number(big.mark = ".",
                                                  decimal.mark = ",")) +
  labs(title="Ocupação diária de leitos de UTI", y= "Leitos de UTI ocupados", x="data")+
  theme_tufte()+
  theme(plot.title = element_text(hjust = 0.5, size=12, face="bold"),
        text = element_text(size=15))

ggplotly(g8) |> 
   layout(images = list(
     list(source = raster2uri(raster),
          xref = "container",
          yref = "container",
          x = 0.1,
          y = 1,
          sizex = 0.15,
          sizey = 0.15,
          opacity = 1.6)
   ))
```


column {data-width=500, .tabset}
-----------------------------------------------------------------------

### Vacinação diária

```{r}
RJ_Total$`Primeira dose` <- RJ_Total$D1
RJ_Total$`Segunda dose ou dose única` <- RJ_Total$D2

g3 <- RJ_Total |> 
  filter(date>="2021-01-01") |> 
  ggplot(aes(x=Data, y=`Primeira dose`))+ 
  geom_bar(stat="identity",
           fill="orange")+
  geom_bar(mapping= aes(y=`Segunda dose ou dose única`),
           stat="identity",
           fill="red", alpha= 0.6)+
  scale_x_date(date_breaks = "month",
               date_labels = "%b/%y")+
  scale_y_continuous(label = scales::label_number(big.mark = ".",
                                                  decimal.mark = ",")) +
  #ylim(c(0,7000)) +
  labs(title="Aplicação diária de Vacinas", y= "Vacinas",
       x= "data",
       color = NULL) + theme_tufte()+
  theme(plot.title = element_text(hjust = 0.5, size=12, face="bold"),
        text = element_text(size=15))

ggplotly(g3) |> 
   layout(images = list(
     list(source = raster2uri(image),
          xref = "container",
          yref = "container",
          x = 0.1,
          y = 1,
          sizex = 0.15,
          sizey = 0.15,
          opacity = 1.6), 
     list(source = raster2uri(doses),
          xref = "container",
          yref = "container",
          x = 0.02,
          y = 0.75,
          sizex = 0.25,
          sizey = 0.25,
          opacity = 1.6)))
```

### Vacinação diária da 1ª dose

```{r}
RJ_Total$`Vacinas aplicadas` <- RJ_Total$D1

g4 <- RJ_Total |> 
  filter(date>="2021-01-01") |> 
  ggplot(aes(x=Data, y=`Vacinas aplicadas`))+ 
  geom_bar(stat="identity",
           fill="red")+
  scale_x_date(date_breaks = "month",
               date_labels = "%b/%y")+
  scale_y_continuous(label = scales::label_number(big.mark = ".",
                                                  decimal.mark = ",")) +
  labs(title="Aplicação diária de Vacinas de 1ª Dose", y= "Vacina de 1ª Dose",
       x= "data")+ 
  theme_tufte()+
  theme(plot.title = element_text(hjust = 0.5, size=12, face="bold"),
        text = element_text(size=15))

ggplotly(g4) |> 
   layout(images = list(
     list(source = raster2uri(raster),
          xref = "container",
          yref = "container",
          x = 0.1,
          y = 1,
          sizex = 0.15,
          sizey = 0.15,
          opacity = 1.6)
   ))

```

### Vacinação diária da 2ª dose ou Dose Única

```{r}
RJ_Total$`Vacinas aplicadas` <- RJ_Total$D2

g5 <- RJ_Total |>   
  filter(date>="2021-01-01") |> 
  ggplot(aes(x=Data, y=`Vacinas aplicadas`))+ 
  geom_bar(stat="identity",
           fill="blue")+
  scale_x_date(date_breaks = "month",
               date_labels = "%b/%y")+
  scale_y_continuous(label = scales::label_number(big.mark = ".",
                                                  decimal.mark = ",")) +
  labs(title="Aplicação diária de Vacinas de 2ª Dose ou Dose Única", y= "Vacina de 2ª Dose ou Dose Única",
       x= "data")+ 
  theme_tufte()+
  theme(plot.title = element_text(hjust = 0.5, size=12, face="bold"),
        text = element_text(size=15))

ggplotly(g5) |> 
   layout(images = list(
     list(source = raster2uri(raster),
          xref = "container",
          yref = "container",
          x = 0.1,
          y = 1,
          sizex = 0.15,
          sizey = 0.15,
          opacity = 1.6)
   ))
```


### Vacinação diária da 3° dose

```{r}
RJ_Total$`Vacinas aplicadas` <- RJ_Total$D3

g20 <- RJ_Total |>   
  filter(date>="2021-01-01") |> 
  ggplot(aes(x=Data, y=`Vacinas aplicadas`))+ 
  geom_bar(stat="identity",
           fill="green")+
  scale_x_date(date_breaks = "month",
               date_labels = "%b/%y")+
  scale_y_continuous(label = scales::label_number(big.mark = ".",
                                                  decimal.mark = ",")) +
  labs(title="Aplicação diária de Vacinas de 3ª Dose", y= "Vacina de 3ª Dose",
       x= "data")+ 
  theme_tufte()+
  theme(plot.title = element_text(hjust = 0.5, size=12, face="bold"),
        text = element_text(size=15))

ggplotly(g20) |>
  layout(images = list(
    list(source = raster2uri(raster),
         xref = "container",
         yref = "container",
         x = 0.7,
         y = 0.9,
         sizex = 0.25,
         sizey = 0.25,
         opacity = 1.6)
  ))

```


Ocupações de Leitos- SRAG por COVID-19
==================================================================

column {data-width=500}
------------------------------------------------------------------

### Leitos clínicos

```{r fig.align='center', echo=FALSE, message=FALSE, warning=FALSE, fig.width = 12}
srag_cli = srag |>
  filter(UTI== 2) |> 
  group_by(FAIXA, ANO) |> 
  summarise(OCUPACOES = n())  |> 
  ungroup()

srag_cli = srag_cli |> 
  mutate(prop_OCUPACOES = round(OCUPACOES / sum(OCUPACOES) * 100,2),
         prop_OCUPACOES =  ifelse(ANO == 2020, -prop_OCUPACOES, prop_OCUPACOES),
         OCUPACOES = ifelse(ANO == 2020, -OCUPACOES, OCUPACOES),
         sinal = ifelse(ANO == 2020, -1, 1))


image = image_fill(image_read("logo_get_uff_covid.png"),"none")
raster = as.raster(image)

g9 =  ggplot(srag_cli) + 
  geom_bar(aes(x = FAIXA, y = prop_OCUPACOES, fill = as.factor(ANO), 
               text = paste("Ocupações: ", abs(OCUPACOES), sep = "")), stat = "identity") + 
  geom_text(size = 2.5,aes(x = FAIXA, y = prop_OCUPACOES + sinal * 2.5 , label = paste(abs(prop_OCUPACOES),"%", sep = ''))) + 
  coord_flip() + 
  scale_fill_manual(name = "", values = c("darkred", "steelblue")) +
  labs(x = "", y = "Ocupações de SRAG por COVID-19 Confirmados (%)", fill= "Ano", title= "Leitos Clínicos") + 
  theme_light()+
  theme(plot.title = element_text(hjust = 0.5, size=12, face="bold"),
        text = element_text(size=15))

ggplotly(g9, tooltip = "text") |> 
  layout(images = list(
    list(source = raster2uri(raster),
         xref = "container",
         yref = "container",
         x = 0.8,
         y = 0.96,
         sizex = 0.15,
         sizey = 0.15,
         opacity = 1.6)
  ))

```

column {data-width=500}
------------------------------------------------------------------

### Leitos de UTI

```{r fig.align='center', echo=FALSE, message=FALSE, warning=FALSE, fig.width = 12}
srag_uti = srag |>
  filter(UTI== 1) |> 
  group_by(FAIXA, ANO) |> 
  summarise(OCUPACOES = n())  |> 
  ungroup()

srag_uti = srag_uti |> 
  mutate(prop_OCUPACOES = round(OCUPACOES / sum(OCUPACOES) * 100,2),
         prop_OCUPACOES =  ifelse(ANO == 2020, -prop_OCUPACOES, prop_OCUPACOES),
         OCUPACOES = ifelse(ANO == 2020, -OCUPACOES, OCUPACOES),
         sinal = ifelse(ANO == 2020, -1, 1))


image = image_fill(image_read("logo_get_uff_covid.png"),"none")
raster = as.raster(image)

g10 =  ggplot(srag_uti) + 
  geom_bar(aes(x = FAIXA, y = prop_OCUPACOES, fill = as.factor(ANO), 
               text = paste("Ocupações: ", abs(OCUPACOES), sep = "")), stat = "identity") + 
  geom_text(size = 2.5,aes(x = FAIXA, y = prop_OCUPACOES + sinal * 2.5 , label = paste(abs(prop_OCUPACOES),"%", sep = ''))) + 
  coord_flip() + 
  scale_fill_manual(name = "", values = c("darkred", "steelblue")) +
  labs(x = "", y = "Ocupações de SRAG por COVID-19 Confirmados (%)", fill= "Ano", title= "Leitos de UTI") + 
  theme_light()+
  theme(plot.title = element_text(hjust = 0.5, size=12, face="bold"),
        text = element_text(size=15))

ggplotly(g10, tooltip = "text") |> 
  layout(images = list(
    list(source = raster2uri(raster),
         xref = "container",
         yref = "container",
         x = 0.8,
         y = 0.96,
         sizex = 0.15,
         sizey = 0.15,
         opacity = 1.6)
  ))

```

Vacinas Covid-19
=======================================================================
  
column {data-width=200}
-----------------------------------------------------------------------

### Primeira dose
  
```{r fig.align='center', echo=FALSE, message=FALSE, warning=FALSE, fig.width = 10}

#pop dos estados do Brasil 2021 (na coluna Valor)
#estados = get_sidra(api="/t/6579/n3/all/v/all/p/last%201")
#estados = estados |> 
#  rename(ibgeID= 'Unidade da Federação (Código)', populacao= Valor) |> 
#  arrange(ibgeID) |> 
#  select(ibgeID, populacao)
RJ_Total$populacao= 17463349


#Acumulado das vacinas aplicadas
RJ_Total= RJ_Total |> 
  filter(date>= "2021-01-01")
RJ_Total$D1= as.character(RJ_Total$D1)
for (i in 1:length(RJ_Total$D1)){
  if(is.na(RJ_Total$D1[i]==T)) RJ_Total$D1[i]="Nao informado"
}
RJ_Total= dplyr::filter(RJ_Total, D1!="Nao informado")
RJ_Total$D1= as.numeric(RJ_Total$D1)

RJ_Total$D1_AC= cumsum(RJ_Total$D1)
RJ_Total$D2_AC= cumsum(RJ_Total$D2)
RJ_Total$D3_AC= cumsum(RJ_Total$D3)

RJ_Total$D2_AC= as.character(RJ_Total$D2_AC)
for (i in 1:length(RJ_Total$D2_AC)){
  if((RJ_Total$date[i]<"2021-01-17")) RJ_Total$D2_AC[i]=NA
}
RJ_Total$D2_AC= as.numeric(RJ_Total$D2_AC)

RJ_Total$D3_AC= as.character(RJ_Total$D3_AC)
for (i in 1:length(RJ_Total$D3_AC)){
  if((RJ_Total$date[i]<"2021-08-03")) RJ_Total$D3_AC[i]=NA
}
RJ_Total$D3_AC= as.numeric(RJ_Total$D3_AC)


#RJ_map <- get_brmap(geo = "City",
#                    geo.filter = list(State = 33),
#                    class = "sf")
#RJ_map = filter(RJ_map, nome=="RJ")

#BaseRJ_aux = RJ_Total
#BaseRJ_aux$city = sub(pattern = "/RJ", replacement = "", x = BaseRJ_aux$city)
#BaseRJ_aux$city = str_to_upper(BaseRJ_aux$city)
#aux_inconsistencia = str_to_upper(aux_inconsistencia)
#RJ = left_join(RJ_map, BaseRJ_aux, by = c("nome" = "city"))
#names(RJ)[1] = "city"


# Criando AS TAXAS
RJ = RJ_Total
RJ = RJ |> 
  filter(date== max(date)) |> 
  mutate(taxaD1= round(D1_AC/populacao, 2),
         taxaD2= round(D2_AC/populacao, 2),
         taxaD3= round(D3_AC/populacao, 2))
         #rotulo= str_c(city, " - ", paste0(round(taxaD1,2)*100, "%")))




gauge(RJ$taxaD1*100, min = 0, max = 100,
      sectors = gaugeSectors(success=c(80,100),warning = c(40,80),danger = c(0,40),
                             colors = c("Red","Red","Red")),
      symbol = "%")
```

### Segunda dose

```{r fig.align='center', echo=FALSE, message=FALSE, warning=FALSE, fig.width = 10}
gauge(RJ$taxaD2*100, min = 0, max = 100,
      sectors = gaugeSectors(success=c(80,100),warning = c(40,80),danger = c(0,40),
                             colors = c("Blue","Blue","Blue")),
      symbol = "%")
```

### Terceira dose

```{r fig.align='center', echo=FALSE, message=FALSE, warning=FALSE, fig.width = 10}
gauge(RJ$taxaD3*100, min = 0, max = 100,
      sectors = gaugeSectors(success=c(80,100),warning = c(40,80),danger = c(0,40),
                             colors = c("Green","Green","Green")),
      symbol = "%")
```

column {data-width=800}
------------------------------------------------------------------

### Vacinação acumulada por tipo de dose

```{r }
RJ_Total$`Aplicações primeira dose` <- RJ_Total$D1_AC
RJ_Total$`Aplicações segunda dose ou dose única` <- RJ_Total$D2_AC
RJ_Total$`Aplicações terceira dose` <- RJ_Total$D3_AC

g6 <- RJ_Total |> 
  ggplot(aes(x=Data, y=`Aplicações primeira dose`, fill = "Primeira dose"))+ 
  geom_line(col= "red")+
  geom_line(aes(y= `Aplicações segunda dose ou dose única`, fill = "Segunda dose ou dose única"),
            col="blue")+
  geom_line(aes(y= `Aplicações terceira dose`, fill = "Terceira dose"),
            col="green")+
  scale_x_date(date_breaks = "month",
               date_labels = "%b/%y")+
  scale_y_continuous(label = scales::label_number(big.mark = ".",
                                                  decimal.mark = ",")) +
  labs(title= "Acumulado de vacinas aplicadas por tipo de dose",
       x= "data",
       y="Vacinas Aplicadas",
       color = NULL) + theme_tufte() +
  theme(legend.position = "top", plot.title = element_text(hjust = 0.5, size=12, face="bold"),
        text = element_text(size=15))

ggplotly(g6) |> 
   layout(images = list(
     list(source = raster2uri(image),
          xref = "container",
          yref = "container",
          x = 0.1,
          y = 1,
          sizex = 0.15,
          sizey = 0.15,
          opacity = 1.6)))



```


```{r}
#load("casosRJ_final.rdata")
#load("srag20.rdata")
#load("srag21.rdata")

load("municipio.rdata")

#casosRJ_final = BaseFinalRJ
#casosRJ_final = dados
#rm(BaseFinalRJ)
#rm(dados)
#casosRJ_final$Populacao = as.numeric(as.character(casosRJ_final$Populacao))

#casosRJ_final = casosRJ_final |> 
#  mutate(tx_casos_mil_diaria = round(CasosNovos / Populacao * 100000, 2),
#         tx_casos_mil = round(CasosAcumulados / Populacao * 100000, 2),
#         tx_mort_mil_diaria = round(ObitosNovos / Populacao * 100000, 2),
#         tx_mort_mil = round(ObitosAcumulados / Populacao * 100000, 2),
#         letalidade = round(ObitosAcumulados / CasosAcumulados * 100, 2))

#table(casosRJ_final$Municipios)
casosRJ_final <- casosRJ_final |> dplyr::filter(ibgeID!=33)
municipios$ibgeID <- as.numeric(municipios$ibgeID)
#casosRJ_final <- left_join(casosRJ_final, municipios, by="ibgeID")

casosRJ_final <- casosRJ_final |> 
  rename(Municipios=city,
         Data=date,
         CasosNovos=newCases,
         ObitosNovos=newDeaths,
         ObitosAcumulados=deaths,
         CasosAcumulados=totalCases,
         tx_mort_mil=deaths_per_100k_inhabitants,
         tx_casos_mil=totalCases_per_100k_inhabitants,
         Populacao=populacao)


casosRJ_final <- casosRJ_final |> 
  mutate(letalidade=round(deaths_by_totalCases * 100,2),
         tx_mort_mil_diaria=round(ObitosNovos / Populacao * 100000, 2),
         tx_casos_mil_diaria = round(CasosNovos / Populacao * 100000, 2))

aux_nome = casosRJ_final |> 
  distinct(Municipios)

casosRJ_final$Data <- ymd(casosRJ_final$Data)
aux_data = casosRJ_final |> 
  distinct(Data)

MM_casos = matrix(NA, ncol = dim(aux_nome)[1], nrow = max(table(casosRJ_final$Municipios)))
MM_casos_max = matrix(NA, ncol = dim(aux_nome)[1], nrow = max(table(casosRJ_final$Municipios)))
MM_obitos = matrix(NA, ncol = dim(aux_nome)[1], nrow = max(table(casosRJ_final$Municipios)))
MM_obitos_max = matrix(NA, ncol = dim(aux_nome)[1], nrow = max(table(casosRJ_final$Municipios)))
MM_tx_casos = matrix(NA, ncol = dim(aux_nome)[1], nrow = max(table(casosRJ_final$Municipios)))
MM_tx_obitos = matrix(NA, ncol = dim(aux_nome)[1], nrow = max(table(casosRJ_final$Municipios)))
casos_max = matrix(NA, ncol = dim(aux_nome)[1], nrow = max(table(casosRJ_final$Municipios)))
obitos_max = matrix(NA, ncol = dim(aux_nome)[1], nrow = max(table(casosRJ_final$Municipios)))
tx_casos_max = matrix(NA, ncol = dim(aux_nome)[1], nrow = max(table(casosRJ_final$Municipios)))
tx_obitos_max = matrix(NA, ncol = dim(aux_nome)[1], nrow = max(table(casosRJ_final$Municipios)))
#prop_CasosNovos = matrix(NA, ncol = dim(aux_nome)[1], nrow = max(table(casosRJ_final$Municipios)))
#prop_ObitosNovos = matrix(NA, ncol = dim(aux_nome)[1], nrow = max(table(casosRJ_final$Municipios)))
#total_casos_periodo1 = matrix(NA, ncol = dim(aux_nome)[1], nrow = max(table(casosRJ_final$Municipios)))

#Periodo1 = os 7 dias mais recentes
#periodo1 = c(max(casosRJ_final$Data, na.rm = T),max(casosRJ_final$Data, na.rm = T) - 6) 
#periodo1_br = paste(day(periodo1),"/",month(periodo1),"/",year(periodo1),sep="")
#Periodo2 = os 7 dias anteriores aos dias da periodo 1
#periodo2 = c(periodo1[2]-1,periodo1[2] - 7)
#periodo2_br = paste(day(periodo2),"/",month(periodo2),"/",year(periodo2),sep="")

aux_inconsistencia = c()
j = 1
for(i in aux_nome$Municipios){
  base_aux = casosRJ_final  |>
    filter(Municipios == i) |> 
    arrange(Data) |>
    distinct(Municipios, Data, .keep_all = T)
  t =length(base_aux$Municipios)
  l = as.numeric(difftime(base_aux$Data[1], as.Date("2020-03-05", units="days"))+1)
  d = as.numeric(as.numeric(difftime(max(base_aux$Data), as.Date("2020-03-05", units="days"))+1))
  
  #Casos
  MM_casos[l:d,j] = movavg(base_aux$CasosNovos, n = 7,type = "s")
  MM_casos_max[,j]=rep(max(MM_casos[,j],na.rm = TRUE),max(table(casosRJ_final$Municipios)))
  
  if(MM_casos[t,j] < 0 | MM_casos[t - 14,j] < 0){
    aux_inconsistencia[j] = i
  }
  
  
  #Taxa casos
  MM_tx_casos[l:d,j] = movavg(base_aux$tx_casos_mil_diaria, n = 7,type = "s")
  
  #Maximo dos casos
  casos_max[,j] = rep(max(base_aux$CasosAcumulados), max(table(casosRJ_final$Municipios)))
  
  #Maximo das taxas de casos
  tx_casos_max[,j] = rep(max(base_aux$tx_casos_mil_diaria,na.rm = T),
                         max(table(casosRJ_final$Municipios)))
  
  #crescimento/decrescimetno do numero de casos novos
  # casosNovos1 = base_aux |> 
  #  filter(Data <= periodo1[1], Data >= periodo1[2])  |> 
  # dplyr::select(CasosNovos) |> 
  #sum(na.rm = T)
  
  #casosNovos2 = base_aux |> 
  # filter(Data <= periodo2[1], Data >= periodo2[2])  |> 
  #dplyr::select(CasosNovos) |> 
  #sum(na.rm = T)
  
  #prop_casos = (casosNovos1 - casosNovos2) / casosNovos2 * 100
  
  #prop_CasosNovos[,j] = rep(round(prop_casos,2), max(table(casosRJ_final$Municipios)))
  
  #total_casos_periodo1[,j] = rep(casosNovos1,  max(table(casosRJ_final$Municipios)))
  
  #if(casosNovos2 < 0 | casosNovos1 < 0)
  # aux_inconsistencia[j] = i
  
  #Obitos
  MM_obitos[l:d,j] = movavg(base_aux$ObitosNovos, n = 7,type = "s")
  MM_obitos_max[,j] = rep(max(MM_obitos[,j], na.rm = T),
                          max(table(casosRJ_final$Municipios)))
  
  
  #taxa Obitos
  MM_tx_obitos[l:d,j] = movavg(base_aux$tx_mort_mil_diaria, n = 7,type = "s")
  
  #Maximo dos obitos
  obitos_max[,j] = rep(max(base_aux$ObitosAcumulados), max(table(casosRJ_final$Municipios)))
  
  #maximo da taxa dos obitos
  tx_obitos_max[,j] = rep(max(base_aux$tx_mort_mil_diaria, na.rm = T),
                          max(table(casosRJ_final$Municipios)))
  
  #crescimento/decrescimetno do numero de obitos novos
  #obitosNovos1 = base_aux |> 
  # filter(Data <= periodo1[1], Data >= periodo1[2])  |> 
  #dplyr::select(ObitosNovos) |> 
  #sum(na.rm = T)
  
  #obitosNovos2 = base_aux |> 
  # filter(Data <= periodo2[1], Data >= periodo2[2])  |> 
  #dplyr::select(ObitosNovos) |> 
  #sum(na.rm = T)
  
  #prop_obitos = (obitosNovos1 - obitosNovos2) / obitosNovos2 * 100
  #prop_ObitosNovos[,j] = rep(round(prop_obitos,2), max(table(casosRJ_final$Municipios)))
  
  
  j = j + 1
  
}

colnames(MM_casos) = aux_nome$Municipios
colnames(MM_obitos) = aux_nome$Municipios
colnames(MM_casos_max) = aux_nome$Municipios
colnames(MM_obitos_max) = aux_nome$Municipios
colnames(casos_max) = aux_nome$Municipios
colnames(obitos_max) = aux_nome$Municipios
colnames(MM_tx_casos) = aux_nome$Municipios
colnames(MM_tx_obitos) = aux_nome$Municipios
colnames(tx_casos_max) = aux_nome$Municipios
colnames(tx_obitos_max) = aux_nome$Municipios
#colnames(prop_CasosNovos) = aux_nome$Municipios
#colnames(prop_ObitosNovos) = aux_nome$Municipios
#colnames(total_casos_periodo1) = aux_nome$Municipios

#Criando a base empilhada de casos
MM_aux_casos = as_tibble(MM_casos)
MM_aux_casos$Data = aux_data$Data
MM_aux_geral_casos = gather(MM_aux_casos, key = "Municipios", value = "MM_casos", -Data)

#Criando a base empilhada da media movel maxima dos casos
MM_aux_casos_max = as_tibble(MM_casos_max)
MM_aux_casos_max$Data = aux_data$Data
MM_aux_geral_casos_max = gather(MM_aux_casos_max, key = "Municipios", value = "MM_casos_max", -Data)

#Criando a base empilhada da taxa de casos
MM_aux_tx_casos = as_tibble(MM_tx_casos)
MM_aux_tx_casos$Data = aux_data$Data
MM_aux_geral_tx_casos = gather(MM_aux_tx_casos, key = "Municipios", value = "MM_tx_casos", -Data)


#Criando base empilhada dos casos maximos
casos_aux_max = as_tibble(casos_max)
casos_aux_max$Data =aux_data$Data
casos_aux_geral_max = gather(casos_aux_max, key = "Municipios", value = "CasosMax", -Data)

#Criando base empilhada das taxas de casos maximos
tx_casos_aux_max = as_tibble(tx_casos_max)
tx_casos_aux_max$Data =aux_data$Data
tx_casos_aux_geral_max = gather(tx_casos_aux_max, key = "Municipios", value = "tx_CasosMax", -Data)

#Criando a base empilhada dos obitos
MM_aux_obitos = as_tibble(MM_obitos)
MM_aux_obitos$Data = aux_data$Data
MM_aux_geral_obitos = gather(MM_aux_obitos, key = "Municipios", value = "MM_obitos", -Data)

#Criando a base empilhada da media movel maxima dos obitos
MM_aux_obitos_max = as_tibble(MM_obitos_max)
MM_aux_obitos_max$Data = aux_data$Data
MM_aux_geral_obitos_max=gather(MM_aux_obitos_max,key = "Municipios", value = "MM_obitos_max", -Data)


#Criando a base empilhada da taxa de obitos
MM_aux_tx_obitos = as_tibble(MM_tx_obitos)
MM_aux_tx_obitos$Data = aux_data$Data
MM_aux_geral_tx_obitos = gather(MM_aux_tx_obitos, key = "Municipios", value = "MM_tx_obitos", -Data)

#criandp base empilhada dos obitos maximos
obitos_aux_max = as_tibble(obitos_max)
obitos_aux_max$Data =aux_data$Data
obitos_aux_geral_max = gather(obitos_aux_max, key = "Municipios", value = "ObitosMax", -Data)

#Criando base empilhada das taxas de obitos maximos
tx_obitos_aux_max = as_tibble(tx_obitos_max)
tx_obitos_aux_max$Data =aux_data$Data
tx_obitos_aux_geral_max = gather(tx_obitos_aux_max, key = "Municipios", value = "tx_ObitosMax", -Data)

#Criando a base empilhada de crescemento ou decrescimento dos casos
#prop_aux_casosNovos = as_tibble(prop_CasosNovos)
#prop_aux_casosNovos$Data = aux_data$Data
#prop_aux_geral_casosNovos = gather(prop_aux_casosNovos, key = "Municipios", value = "Prop_CasosNovos", -Data)

#Criando a base empilhada do total de casos no periodo 1
#total_casos_periodo1 = as_tibble(total_casos_periodo1)
#total_casos_periodo1$Data = aux_data$Data
#total_aux_geral_casos_periodo1 = gather(total_casos_periodo1, key = "Municipios", value = "Casos_periodo1", -Data)

#Criando a base empilhada de crescemento ou decrescimento dos obitos
#prop_aux_obitosNovos = as_tibble(prop_ObitosNovos)
#prop_aux_obitosNovos$Data = aux_data$Data
#prop_aux_geral_obitosNovos = gather(prop_aux_obitosNovos, key = "Municipios", value = "Prop_ObitosNovos", -Data)

#Adicionando as bases à base casosRJ_final

#Casos maximos e taxa maxima de casos
casosRJ_final = left_join(casosRJ_final, casos_aux_geral_max, by = c("Data", "Municipios"))
casosRJ_final = left_join(casosRJ_final, tx_casos_aux_geral_max, by = c("Data", "Municipios"))

# Media movel dos casos e media movel ponderada
casosRJ_final = left_join(casosRJ_final,MM_aux_geral_casos, by = c("Data", "Municipios", "MM_casos"))
casosRJ_final = left_join(casosRJ_final,MM_aux_geral_casos_max, by = c("Data", "Municipios"))
casosRJ_final$MM_casos_pond = casosRJ_final$MM_casos / casosRJ_final$MM_casos_max

#Media Movel das taxas de casos 
casosRJ_final = left_join(casosRJ_final,MM_aux_geral_tx_casos, by = c("Data", "Municipios"))


#obitos maximos e taxa maxima de obitos
casosRJ_final = left_join(casosRJ_final,obitos_aux_geral_max, by = c("Data", "Municipios"))
casosRJ_final = left_join(casosRJ_final,tx_obitos_aux_geral_max, by = c("Data", "Municipios"))

# Media movel dos obitos e media movel ponderada
casosRJ_final = left_join(casosRJ_final,MM_aux_geral_obitos, by = c("Data", "Municipios", "MM_obitos"))
casosRJ_final = left_join(casosRJ_final,MM_aux_geral_obitos_max, by = c("Data", "Municipios"))
casosRJ_final$MM_obitos_pond = casosRJ_final$MM_obitos / casosRJ_final$MM_obitos_max

#Media Movel das taxas de obitos 
casosRJ_final = left_join(casosRJ_final,MM_aux_geral_tx_obitos, by = c("Data", "Municipios"))

#MM_tx = left_join(MM_aux_geral_tx_casos,MM_aux_geral_tx_obitos, by = c("Data", "Municipios"))
#MM_tx_max = left_join(tx_casos_aux_geral_max,tx_obitos_aux_geral_max, by = c("Data", "Municipios"))
#MM_tx_final = left_join(MM_tx, MM_tx_max, by = c("Data", "Municipios"))
#MM_final = left_join(MM_aux_geral_casos, MM_aux_geral_obitos, by = c("Data","Municipios"))
#MM_final1 = left_join(MM_final, casos_aux_geral_max, by = c("Data","Municipios"))
#MM_final2 = left_join(MM_final1, obitos_aux_geral_max, by = c("Data","Municipios"))
#MM_final3 = left_join(MM_final2, MM_tx_final,by = c("Data","Municipios"))
#casosRJ_final = left_join(casosRJ_final, MM_final3, by = c("Data","Municipios"))
#casosRJ_final = left_join(casosRJ_final, prop_aux_geral_casosNovos, by = c("Data", "Municipios"))
#casosRJ_final = left_join(casosRJ_final, total_aux_geral_casos_periodo1, by = c("Data", "Municipios"))
#casosRJ_final = left_join(casosRJ_final, prop_aux_geral_obitosNovos, by = c("Data", "Municipios"))


#Criando a variavel numero de dias

#Calculando a data do N-ésimo caso por cidade
N_dias_casos = 1
primeiro_caso_RJ = casosRJ_final |> 
  filter(CasosAcumulados >= N_dias_casos) |>
  group_by(Municipios) |> 
  summarise(primeiro_dia_caso = min(Data))

#Calculando a data do N-ésimo caso por cidade
N_dias_obitos = 1
primeiro_obito_RJ = casosRJ_final |>
  filter(ObitosAcumulados >= N_dias_obitos) |> 
  group_by(Municipios) |> 
  summarise(primeiro_dia_obito = min(Data))

#Acrescentando a data do primeiro caso por RJ na base
casosRJ_final = left_join(casosRJ_final, primeiro_caso_RJ, by = "Municipios")

#Acrescentando a data do primeiro obito por RJ na base
casosRJ_final = left_join(casosRJ_final, primeiro_obito_RJ, by = "Municipios")

#Calcluando o numero de dias desde o N-ésimo caso e N-ésimo obito para cada data notificada por RJ
casosRJ_final = casosRJ_final |> 
  mutate(num_dias_caso = time_length(Data-primeiro_dia_caso, "day")+1,
         num_dias_obito = time_length(Data-primeiro_dia_obito, "day")+1)

casosRJ_final$num_dias_caso[casosRJ_final$num_dias_caso <= 0] = NA
casosRJ_final$num_dias_obito[casosRJ_final$num_dias_obito <= 0] = NA

#Calculando letalidade e taxa por 100000 habitantes

#Ultima data de coleta de dados
data_hoje = paste(day(max(casosRJ_final$Data)),"/",month(max(casosRJ_final$Data)),"/",year(max(casosRJ_final$Data)),sep = "")

#Número de cidades
num_cidades = 10

```

Resumos atualizados Covid-19
=======================================================================
  
column {data-width=500, .tabset}
-----------------------------------------------------------------------
  
### Casos
  
```{r fig.align='center', echo=FALSE, message=FALSE, warning=FALSE, fig.width = 12}
#Criando a base de totais do ultimo dia divulgado por municipio
base_atual_todos = casosRJ_final |>
  filter(Data == max(Data))

base_atual = casosRJ_final |>
  filter(Data == max(Data)) |> 
  top_n(CasosAcumulados, n = num_cidades)

#Número de casos por estado
g1 = ggplot(base_atual) +
  geom_bar(aes(x = fct_reorder(Municipios, CasosAcumulados), 
               y = CasosAcumulados), 
           stat = 'identity',
           width = 0.65) + 
  coord_flip() +
  theme_light() + 
  xlab('') + 
  ylab('') + 
  ggtitle('Casos \n Para os 10 municípios com mais casos') + 
  theme(axis.title.x=element_blank(), 
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(),
        plot.title = element_text(size=9)) +
  scale_y_continuous(name="", 
                     limits=c(0, max(base_atual$CasosAcumulados) * 1.4)) +
  geom_text(aes(x = fct_reorder(Municipios, CasosAcumulados), 
                y = CasosAcumulados, 
                label = prettyNum(CasosAcumulados, big.mark = ".", decimal.mark = ","), 
                hjust = -0.1), 
            size = 3.5)+
  annotation_custom(rasterGrob(img),
                    xmin=paste(base_atual$Municipios[base_atual$CasosAcumulados == sort(base_atual$CasosAcumulados)[2]][1]),
                    xmax=paste(base_atual$Municipios[base_atual$CasosAcumulados == sort(base_atual$CasosAcumulados)[1]]),
                    ymin= max(base_atual$CasosAcumulados)*0.5, ymax =max(base_atual$CasosAcumulados) * 1.4)

g1

```

### Óbitos

```{r fig.align='center', echo=FALSE, message=FALSE, warning=FALSE, fig.width = 12}
#Número de mortes por estado
g2 = ggplot(base_atual) +
  geom_bar(aes(x = fct_reorder(Municipios, CasosAcumulados), 
               y = ObitosAcumulados), 
           stat = 'identity', 
           width = 0.65) + 
  coord_flip() +
  theme_light() + 
  xlab('') + 
  ylab('') + 
  ggtitle('Óbitos \n Para os 10 municípios com mais casos') + 
  theme(axis.title.x=element_blank(), 
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(),
        #        axis.title.y=element_blank(), 
        #        axis.text.y=element_blank(), 
        #        axis.ticks.y=element_blank(),
        plot.title = element_text(size=9)) +
  scale_y_continuous(name = "", 
                     limits = c(0, max(base_atual$ObitosAcumulados) * 1.4)) +
  geom_text(aes(x = fct_reorder(Municipios, CasosAcumulados), 
                y = ObitosAcumulados, 
                label = prettyNum(ObitosAcumulados, big.mark = ".", decimal.mark = ","), 
                hjust = -0.1), 
            size = 3.5)+
  annotation_custom(rasterGrob(img),
                    xmin=paste(base_atual$Municipios[base_atual$CasosAcumulados == sort(base_atual$CasosAcumulados)[2]][1]),
                    xmax=paste(base_atual$Municipios[base_atual$CasosAcumulados == sort(base_atual$CasosAcumulados)[1]]),
                    ymin = max(base_atual$ObitosAcumulados)*0.5 , ymax = max(base_atual$ObitosAcumulados) * 1.4)

g2

```

### Letalidade 

```{r fig.align='center', echo=FALSE, message=FALSE, warning=FALSE, fig.width = 12}
base_topo = data.frame(x = fct_reorder(base_atual$Municipios, base_atual$CasosAcumulados), y = base_atual$letalidade)

#letalidade por estado
g3 = ggplot(base_atual) +
  geom_bar(aes(x = fct_reorder(Municipios, CasosAcumulados), 
               y = letalidade), 
           stat = 'identity', 
           fill = '#ffa600',  
           width = 0.14) + 
  coord_flip() +
  theme_light() + 
  xlab('') + 
  ylab('') + 
  ggtitle(paste('Letalidade - média UF:',prettyNum(round(mean(base_atual_todos$letalidade, na.rm = TRUE), 2), big.mark = ".", decimal.mark = ",") , "% \n Para os 10 municípios com mais casos")) + 
  theme(axis.title.x=element_blank(), 
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),                        
        plot.title = element_text(size=9), 
        plot.subtitle = element_text(size = 10, 
                                     face = 'bold')) +
  scale_y_continuous(name = "", limits = c(0, 50)) +
  geom_text(aes(x = fct_reorder(Municipios, CasosAcumulados),
                y = max(letalidade) + 20,
                label = paste(letalidade,"%"), 
                hjust = 1),
            size = 3.5) +
  geom_hline(yintercept = mean(base_atual_todos$letalidade, na.rm = TRUE), 
             linetype = 'dashed', 
             color = 'black') +
  geom_point(data = base_topo, 
             aes(x = x, y = y), 
             color = '#ffa600', 
             size = 5)

g3

```


### Número de casos por 100.000 habitantes

```{r fig.align='center', echo=FALSE, message=FALSE, warning=FALSE, fig.width = 12}
g4 = ggplot(base_atual) +
  geom_bar(aes(x = fct_reorder(Municipios, tx_casos_mil), 
               y = tx_casos_mil),
           stat = 'identity', 
           width = 0.65, 
           fill = '#0094d8', 
           alpha = 0.8) + 
  coord_flip() +
  xlab('') + 
  theme_light() + 
  ylab('') + 
  scale_y_continuous(name="", 
                     limits=c(0,max(base_atual$tx_casos_mil) * 1.3)) +
  geom_text(aes(x = fct_reorder(Municipios, tx_casos_mil), 
                y = tx_casos_mil, 
                label = prettyNum(tx_casos_mil, big.mark = ".", decimal.mark = ","), 
                hjust = -0.1), 
            size = 3.5) +
  ggtitle('Taxa de Casos por 100 mil hab. \n Para os 10 municípios com mais casos') +
  theme(axis.title.x = element_blank(),
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        plot.title = element_text(size=9))+
  annotation_custom(rasterGrob(img),
                    xmin=paste(base_atual$Municipios[base_atual$tx_casos_mil == sort(base_atual$tx_casos_mil)[3]]),
                    xmax=paste(base_atual$Municipios[base_atual$tx_casos_mil == sort(base_atual$tx_casos_mil)[1]]),
                    ymin = max(base_atual$tx_casos_mil) * 0.6, ymax = max(base_atual$tx_casos_mil) * 1.3)

g4

```

### Número de mortes por 100.000 habitantes

```{r fig.align='center', echo=FALSE, message=FALSE, warning=FALSE, fig.width = 12}
g5 = ggplot(base_atual) +
  geom_bar(aes(x = fct_reorder(Municipios, tx_mort_mil), 
               y = tx_mort_mil), 
           stat = 'identity', 
           width = 0.65, 
           fill = '#ffa600', 
           alpha = 0.8) + 
  coord_flip() +
  xlab('') + 
  theme_light() + 
  ylab('') + 
  scale_y_continuous(name="", 
                     limits=c(0, max(base_atual$tx_mort_mil) * 1.1)) +
  geom_text(aes(x = fct_reorder(Municipios, tx_mort_mil), 
                y = tx_mort_mil, 
                label = prettyNum(tx_mort_mil, big.mark = ".", decimal.mark = ","), 
                hjust = -0.1), 
            size = 3.5) +
  ggtitle('Taxa de Óbitos por 100 mil hab. \n Para os 10 municípios com mais casos') +
  theme(axis.title.x=element_blank(), 
        axis.text.x=element_blank(), 
        axis.ticks.x=element_blank(), 
        plot.title = element_text(size=9))+
  annotation_custom(rasterGrob(img),
                    xmin=paste(base_atual$Municipios[base_atual$tx_mort_mil == sort(base_atual$tx_mort_mil)[3][1]]),
                    xmax=paste(base_atual$Municipios[base_atual$tx_mort_mil == sort(base_atual$tx_mort_mil)[1]]),
                    ymin = max(base_atual$tx_mort_mil) * 0.6, ymax = max(base_atual$tx_mort_mil) * 1.1)

g5

```



```{r fig.align='center', echo=FALSE, message=FALSE, warning=FALSE, fig.width = 10}
#load("casosRJ_final.rdata")
RJ_Muni= casosRJ_final |>
  select(Data, Municipios, D1, D2, D3) 

RJ_Muni$D1= as.character(RJ_Muni$D1)
for (i in 1:length(RJ_Muni$D1)){
  if(is.na(RJ_Muni$D1[i]==T)) RJ_Muni$D1[i]=0
}
RJ_Muni$D1= as.numeric(RJ_Muni$D1)

for (i in 1:length(RJ_Muni$D2)){
  if(is.na(RJ_Muni$D2[i]==T)) RJ_Muni$D2[i]=0
}
RJ_Muni$D2= as.numeric(RJ_Muni$D2)

for (i in 1:length(RJ_Muni$D3)){
  if(is.na(RJ_Muni$D3[i]==T)) RJ_Muni$D3[i]=0
}
RJ_Muni$D3= as.numeric(RJ_Muni$D3)

#Data_hoje = max(casosRJ_final$Data)

RJ_Muni = RJ_Muni |> 
  group_by(Municipios) |> 
  summarise(Data= Data, D1_AC= cumsum(D1), D2_AC= cumsum(D2), 
            D3_AC= cumsum(D3))

```

Mapas
=======================================================================
  
column {data-width=500, .tabset}
-----------------------------------------------------------------------
  
### Mapa da proporção da população vacinada com a 1° dose
  
```{r fig.align='center', echo=FALSE, message=FALSE, warning=FALSE, fig.width = 10}
#Mapa Primeira Dose
# Criando o mapa
rio2_map <- get_brmap(geo = "City",
                      geo.filter = list(State = 33),
                      class = "sf")
rio2_map = rio2_map[,c(1,7)]

BaseRJ_aux = RJ_Muni
BaseRJ_aux$Municipios = str_to_upper(BaseRJ_aux$Municipios)
#aux_inconsistencia = str_to_upper(aux_inconsistencia)
rio2 = left_join(rio2_map, BaseRJ_aux, by = c("nome" = "Municipios"))
names(rio2)[1] = "Municipios"
aux = rio2$MM_casos[rio2$Data == max(rio2$Data - 14)]

rio2 = rio2 |> 
  filter(Data == max(Data)) 

municipios = municipios |> 
  left_join(casosRJ_final, by= "ibgeID") |> 
  filter(Data == max(Data)) |> 
  mutate(Municipios = str_to_upper(Municipios))

rio2 = rio2 |> 
  left_join(municipios, by= c("Municipios","Data"))

rio2 = rio2 |> 
  mutate(taxaD1= round(D1_AC/populacao, 2),
         taxaD2= round(D2_AC/populacao, 2),
         taxaD3= round(D3_AC/populacao, 2),
         rotulo1= str_c(Municipios, " - ", paste0(round(taxaD1,2)*100, "%")),
         rotulo2= str_c(Municipios, " - ", paste0(round(taxaD2,2)*100, "%")),
         rotulo3= str_c(Municipios, " - ", paste0(round(taxaD3,2)*100, "%")))

for (i in 1:length(rio2$taxaD1)){
  if (is.na(rio2$taxaD1[i])==T) rio2$taxaD1[i]= "VALOR FALTANTE"
}

rio2$situacao= NA

for (i in 1:length(rio2$taxaD1)){
  if(is.na(rio2$taxaD1[i])==T) 
    rio2$situacao[i] = "A"
  else{
    if((rio2$taxaD1[i])< 0.25)
      rio2$situacao[i] = "B"
    else{
      if((rio2$taxaD1[i])< 0.5)
        rio2$situacao[i] = "C"
      else{
        if((rio2$taxaD1[i])< 0.75)
          rio2$situacao[i] = "D"
        else{rio2$situacao[i] = "E"}
      }
    }  
  }
}

rio2$situacao = ordered(rio2$situacao, 
                        levels = c("A",  "B",  "C",  "D", "E"), 
                        labels = c("Dados Inconsistentes",
                                   "0-25", 
                                   "25-50", 
                                   "50-75", 
                                   "75-100"))

red = brewer.pal(9,"Reds")
gre = brewer.pal(9,"Greens")
yel = brewer.pal(9,"YlOrBr")
blu = brewer.pal(9,"Blues")

tmap_mode("view")
tm_shape(rio2) + 
  tm_polygons("situacao",
              border.col = "white",
              title = "Taxa de pessoas vacinadas com a 1ª dose da vacina da COVID no estado do Rio de Janeiro (%)",
              id = "rotulo1",
              popup.vars=c("Taxa 1ª Dose:" = "taxaD1",
                           "Taxa 2ª Dose/ Dose Única:" = "taxaD2",
                           "Taxa 3ª Dose (Reforço):" = "taxaD3"), 
              popup.format=list(taxaD1=list(digits=2)),
              palette = c("gray",red[3],red[5],red[7],red[9]),
              textNA = "Valor Faltante",
              set.view = 6, legend.show = T)  +
  tm_view(alpha = 1, view.legend.position = c("left","bottom")) +
  tm_add_legend(labels = "Clique em um município para mais informações!", col = "white")

```

### Mapa da proporção da população vacinada com a 2° dose ou dose única

```{r fig.align='center', echo=FALSE, message=FALSE, warning=FALSE, fig.width = 10}
#Mapa Segunda Dose/ Dose Única
# Criando o mapa

for (i in 1:length(rio2$taxaD2)){
  if (is.na(rio2$taxaD2[i])==T) rio2$taxaD2[i]= "VALOR FALTANTE"
}

rio2$situacao= NA

for (i in 1:length(rio2$taxaD2)){
  if(is.na(rio2$taxaD2[i])==T) 
    rio2$situacao[i] = "A"
  else{
    if((rio2$taxaD2[i])< 0.25)
      rio2$situacao[i] = "B"
    else{
      if((rio2$taxaD2[i])< 0.5)
        rio2$situacao[i] = "C"
      else{
        if((rio2$taxaD2[i])< 0.75)
          rio2$situacao[i] = "D"
        else{rio2$situacao[i] = "E"}
      }
    }  
  }
}

rio2$situacao = ordered(rio2$situacao, 
                        levels = c("A",  "B",  "C",  "D", "E"), 
                        labels = c("Dados Inconsistentes",
                                   "0-25", 
                                   "25-50", 
                                   "50-75", 
                                   "75-100"))

red = brewer.pal(9,"Reds")
gre = brewer.pal(9,"Greens")
yel = brewer.pal(9,"YlOrBr")
blu = brewer.pal(9,"Blues")

tm_shape(rio2) + 
  tm_polygons("situacao",
              border.col = "white",
              title = "Taxa de pessoas vacinadas com a 2ª dose ou Dose Única da vacina da COVID no estado do Rio de Janeiro (%)",
              id = "rotulo2",
              popup.vars=c("Taxa 1ª Dose:" = "taxaD1",
                           "Taxa 2ª Dose/ Dose Única:" = "taxaD2",
                           "Taxa 3ª Dose (Reforço):" = "taxaD3"), 
              popup.format=list(taxaD2=list(digits=2)),
              palette = c("gray",blu[3],blu[5],blu[7],blu[9]),
              textNA = "Valor Faltante",
              set.view = 6, legend.show = T)  +
  tm_view(alpha = 1, view.legend.position = c("left","bottom")) +
  tm_add_legend(labels = "Clique em um município para mais informações!", col = "white")

```

### Mapa da proporção da população vacinada com a 3° dose

```{r fig.align='center', echo=FALSE, message=FALSE, warning=FALSE, fig.width = 10}
#Mapa Terceira Dose
# Criando o mapa

for (i in 1:length(rio2$taxaD3)){
  if (is.na(rio2$taxaD3[i])==T) rio2$taxaD3[i]= "VALOR FALTANTE"
}

rio2$situacao= NA

for (i in 1:length(rio2$taxaD3)){
  if(is.na(rio2$taxaD3[i])==T) 
    rio2$situacao[i] = "A"
  else{
    if((rio2$taxaD3[i])< 0.25)
      rio2$situacao[i] = "B"
    else{
      if((rio2$taxaD3[i])< 0.5)
        rio2$situacao[i] = "C"
      else{
        if((rio2$taxaD3[i])< 0.75)
          rio2$situacao[i] = "D"
        else{rio2$situacao[i] = "E"}
      }
    }  
  }
}

rio2$situacao = ordered(rio2$situacao, 
                        levels = c("A",  "B",  "C",  "D", "E"), 
                        labels = c("Dados Inconsistentes",
                                   "0-25", 
                                   "25-50", 
                                   "50-75", 
                                   "75-100"))

red = brewer.pal(9,"Reds")
gre = brewer.pal(9,"Greens")
yel = brewer.pal(9,"YlOrBr")
blu = brewer.pal(9,"Blues")

tm_shape(rio2) + 
  tm_polygons("situacao",
              border.col = "white",
              title = "Taxa de pessoas vacinadas com a 3ª dose (de Reforço) da vacina da COVID no estado do Rio de Janeiro (%)",
              id = "rotulo3",
              popup.vars=c("Taxa 1ª Dose:" = "taxaD1",
                           "Taxa 2ª Dose/ Dose Única:" = "taxaD2",
                           "Taxa 3ª Dose (Reforço):" = "taxaD3"), 
              popup.format=list(taxaD3=list(digits=2)),
              palette = c("gray",gre[3],gre[5],gre[7],gre[9]),
              textNA = "Valor Faltante",
              set.view = 6, legend.show = T)  +
  tm_view(alpha = 1, view.legend.position = c("left","bottom")) +
  tm_add_legend(labels = "Clique em um município para mais informações!", col = "white")

```